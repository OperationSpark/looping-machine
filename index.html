
<head>
  <style> 
    body {
      padding: 0; 
      margin: 0;
    } 
  </style>
  <script language="javascript" src="bower_components/jquery/dist/jquery.js"></script>
  <script language="javascript" src="p5/lib/p5.js"></script>
  <script language="javascript" src="p5/lib/addons/p5.dom.js"></script>
  <script language="javascript" src="p5/lib/addons/p5.sound.js"></script>
</head>

<body>
  <ul id="tracks">
    <li>
      <button class="record">Record</button>
      <button class="stopRecording" disabled>Stop Record</button>
      <button class="play" disabled>Play</button>
      <button class="pause" disabled>Pause</button>
      <aside class="status">Waiting...</aside>
    </li>
    <li>
      <button class="record">Record</button>
      <button class="stopRecording" disabled>Stop Record</button>
      <button class="play" disabled>Play</button>
      <button class="pause" disabled>Pause</button>
      <aside class="status">Waiting...</aside>
    </li>
  </ul>
  <script>
    (function() { 
      var tracksList = $("[id=tracks]");
     
      var mic = new p5.AudioIn();
      mic.start();
      
      var disable = function(itemsToDisable) {
        itemsToDisable.map(function(item){ 
          item.prop('disabled', true);
        });
      }
      var enable = function(itemsToEnable) {
        itemsToEnable.map(function(item){ 
          item.prop('disabled', false);
        });
      }
      
      var setupControls = function(container) {
        var recordButton = $("[class=record]", container);
        var stopRecordingButton = $("[class=stopRecording]", container);
        var playButton = $("[class=play]", container);
        var pauseButton = $("[class=pause]", container);
        var statusText = $("[class=status]", container);
        
        var soundFile;
        var recorder = new p5.SoundRecorder();
        recorder.setInput(mic);
        
        recordButton.on('click', function() {
          if(!mic.enabled) {
            alert("You have to enable the microphone first!")
          } else {
            disable([recordButton, playButton, pauseButton]);
            enable([stopRecordingButton]);
            if(soundFile) {
              soundFile.stop();
              soundFile.disconnect();
            }
            soundFile = new p5.SoundFile();
            recorder.record(soundFile);
            statusText.text("Recording");
          }
        });
        
        stopRecordingButton.on('click', function() {
          disable([stopRecordingButton, pauseButton]);
          enable([recordButton, playButton]);
          recorder.stop(); // sends the result to the soundFile
          statusText.text("Recorded");
        });
        
        playButton.on('click', function() {
          disable([stopRecordingButton,, playButton]);
          enable([recordButton, pauseButton]);
          soundFile.loop();
          statusText.text("Playing");
        });
        
        pauseButton.on('click', function() {
          disable([stopRecordingButton, pauseButton]);
          enable([recordButton, playButton]);
          soundFile.pause();
          statusText.text("Paused");
        });
        
      };
      tracksList.find("li").toArray().forEach(setupControls)
      
      window.setup = function(){}; //p5 doees not seem to initialize unless there"s a global setup method
    })()
  </script>
</body>