<head>
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    input[type=range] {
      width: 300px;
    }
    label {
      display: block;
    }
  </style>
  <script src="bower_components/jquery/dist/jquery.js"></script>
  <script src="p5/lib/p5.js"></script>
  <script src="p5/lib/addons/p5.sound.js"></script>
  <script src="looper.js"></script>
</head>

<body>
  <ul id="tracks"> </ul>
  <fieldset>
    <button id="add-track">Add Track</button>
  </fieldset>

  <template id="track-template">
    <li>
      <aside class="status">Waiting...</aside>
      <button class="record">Record</button>
      <button class="stopRecording" disabled>Stop Record</button>
      <button class="play" disabled>Play</button>
      <button class="pause" disabled>Pause</button>
      <label>
        Rate:
        <input class="rate" type="range" min="0.1" max="3" step="0.1" value="1" disabled>
      </label>
      <label>
        Volume:
        <input class="volume" type="range" min="0.1" max="5" step="0.2" value="1" disabled>
      </label>
    </li>
  </template>

  <script>
    $(function() {
      "use strict"
      var tracksList = $("[id=tracks]");
      var addTrackButton = $("[id=add-track]");

      var setupControls = function(container) {
        var recordButton = $("[class=record]", container);
        var stopRecordingButton = $("[class=stopRecording]", container);
        var playButton = $("[class=play]", container);
        var pauseButton = $("[class=pause]", container);
        var rateControl = $("[class=rate]", container);
        var volumeControl = $("[class=volume]", container);
        var statusText = $("[class=status]", container);

        var controls = looper.getControlHelper();

        recordButton.on("click", function() {
          looper.disable(recordButton, playButton, pauseButton, rateControl, volumeControl);
          looper.enable(stopRecordingButton);
          controls.startRecording();
          statusText.text("Recording");
        });

        stopRecordingButton.on("click", function() {
          looper.disable(stopRecordingButton, pauseButton);
          looper.enable(recordButton, playButton, rateControl, volumeControl);
          controls.stopRecording();
          statusText.text("Recorded");
        });

        playButton.on("click", function() {
          looper.disable(stopRecordingButton, playButton);
          looper.enable(recordButton, pauseButton, rateControl, volumeControl);
          controls.playLoop();
          statusText.text("Playing");
        });

        pauseButton.on("click", function() {
          looper.disable(stopRecordingButton, pauseButton);
          looper.enable(recordButton, playButton, rateControl, volumeControl);
          controls.pause();
          statusText.text("Paused");
        });

        rateControl.on("change", function() {
          controls.resetRate();
        });

        volumeControl.on("change", function() {
          controls.resetVolume();
        });

      };

      var addTrack = function() {
        var container = looper.createNewControlsHtml();
        setupControls(container);
        tracksList.append(container);
      }

      addTrackButton.on("click", addTrack);
      addTrack();
        var controls = looper.getControlHelper();

    });
  </script>
</body>
